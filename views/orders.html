<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Order List</title>
<!--    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.2.1/dist/css/bootstrap.min.css" integrity="sha384-GJzZqFGwb1QTTN6wy59ffF1BuGJpLSa9DkKMp0DgiMDm4iYMj70gZWKYbI706tWS" crossorigin="anonymous">    <link href="https://getbootstrap.com/docs/4.1/examples/pricing/pricing.css" rel="stylesheet"-->
          crossorigin="anonymous">
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet"/>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css">

    <style>
        div[done], td[done] {
            background-color: lightgreen;
        }
        .content-container {
            min-height: 100vh; /* Set a minimum height for scrolling */
            padding-bottom: 100px; /* Account for edit box height */
        }
        #edit-panel {
            position: fixed;
            top: 0;
            right: 0;
            width: 50%;
            background-color: #fff;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
            padding: 1rem;
        //display: none; /* Initially hidden */
        }
    </style>
</head>
<body>
<div class="d-flex flex-column flex-md-row align-items-center p-3 px-md-4 mb-3 bg-white border-bottom shadow-sm">
    <img src="assets/logo.png" height="50" class="d-inline-block align-top mr-md-4" alt="">
    <img src="assets/bossard.png" height="30" class="d-inline-block align-left mr-md-4" alt="">
    <img src="assets/sick.png" height="30" class="d-inline-block align-left mr-md-auto" alt="">

    <nav class="my-2 my-md-0 mr-md-3">
        <a class="p-2 text-dark" href="../worker.html">Worker ID: <span id="worker-id"></span></a>
        <a class="p-2 text-dark" href="#">Target: <span id="target-id"></span></a>
        <a class="btn btn-outline-secondary" href="../index.html">Pickup</a>
    </nav>
    <button type="button" class="btn btn-primary" data-toggle="modal"  data-target="#createOrder">Create</button>

</div>

<div class="breadcrumb">
    <div class="mr-md-auto">Orders</div>
</div>

<div class="modal fade" id="createOrder" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLongTitle">Create Order</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="orderForm">
                    <div class="form-row">
                        <div class="col-10">
                            <label for="screwSelector">Screws</label>
                            <input type="range" value="24" min="1" max="50" oninput="document.getElementById('screwField').value = this.value" class="form-control-range" id="screwSelector">
                        </div>
                        <div class="col-2">
                            <input type="text" value="24"  class="form-control" id="screwField">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="col-10">
                            <label for="boltSelector">Bolt</label>
                            <input type="range" value="24" min="1" max="50" oninput="document.getElementById('boltField').value = this.value" class="form-control-range" id="boltSelector">
                        </div>
                        <div class="col-2">
                            <input type="text" value="24"  class="form-control" id="boltField">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="col-10">
                            <label for="nutSelector">Nuts</label>
                            <input type="range" value="24" min="1" max="50" oninput="document.getElementById('nutField').value = this.value" class="form-control-range" id="nutSelector">
                        </div>
                        <div class="col-2">
                            <input type="text" value="24"  class="form-control" id="nutField">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="col">
                            <label for="nutSelector">Worker</label>
                            <select class="form-control" id="workerSelect">
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="col">
                            <label for="nutSelector">Location</label>
                            <select class="form-control" id="locationSelect">
                            </select>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="createOrderButton" data-dismiss="modal">Create</button>
            </div>
        </div>
    </div>
</div>

<div class="pricing-header px-3 py-3 pt-md-5 pb-md-4 mx-auto text-center">
    <h1 class="display-4">Open Orders</h1>
</div>

<div class="container">
    <table class="table">
        <thead>
            <tr>
                <th scope="col">#</th>
                <th scope="col">Worker</th>
                <th scope="col">Location</th>
                <th scope="col">Screws</th>
                <th scope="col">Bolts</th>
                <th scope="col">Nuts</th>
                <th scope="col">Time</th>
                <th scope="col">Actions</th>
            </tr>
        </thead>
        <tbody id="orderList">
        </tbody>
    </table>



    <footer class="pt-4 my-md-5 pt-md-5 border-top">
        <div class="row">
            <div class="col-6">
                <img class="mb-2" src="assets/logo.png" alt="" width="100%">
                <small class="d-block mb-3 text-muted">&copy; 2024</small>
            </div>
            <div class="col-3">
                <h5>Features</h5>
                <ul class="list-unstyled text-small">
                    <li><a class="text-muted" href="https://e4tc.de/">Cool stuff</a></li>
                    <li><a class="text-muted" href="https://e4tc.de/">Random feature</a></li>
                    <li><a class="text-muted" href="https://e4tc.de/">Team feature</a></li>
                    <li><a class="text-muted" href="https://e4tc.de/">Stuff for developers</a></li>
                </ul>
            </div>
            <div class="col-3">
                <h5>About</h5>
                <ul class="list-unstyled text-small">
                    <li><a class="text-muted" href="https://e4tc.de/">Team</a></li>
                    <li><a class="text-muted" href="https://e4tc.de/">Locations</a></li>
                    <li><a class="text-muted" href="https://e4tc.de/">Privacy</a></li>
                    <li><a class="text-muted" href="https://e4tc.de/">Terms</a></li>
                </ul>
            </div>
        </div>
    </footer>
</div>


<script>
    const confirmOrder = (id) => {
        fetch("/pick_orders/"+id, {method: 'PATCH', body: JSON.stringify({done: true})})
            .then((response) => response.json())
            .then((json) => {
                console.log(json)
                fetchCurrentOrder();
                fetchOrders();
            })
            .catch(error => console.error("Error updating latest pick order:", error));
    }

    const deleteOrder = (id) => {
        fetch("/orders/"+id, {method: 'DELETE'})
            .then((response) => response.json())
            .then((json) => {
                console.log(json)
                fetchCurrentOrder();
                fetchOrders();
            })
            .catch(error => console.error("Error deleting order:", error));
    }

    const fetchCurrentOrder = () => {
        fetch("/orders/latest")
            .then((response) => response.json())
            .then((json) => {
                var worker = json.workers.find(({id}) => id === 1)
                var location = json.locations.find(({id}) => id === 1)
                document.getElementById("worker-id").innerHTML = worker.title;
                document.getElementById("target-id").innerHTML = location.title;
            })
            .catch(error => console.error("Error updating latest order:", error));
    }
    const fetchOrders = () => {
        fetch("/orders")
            .then((response) => response.json())
            .then((json) => {
                const orderList = document.getElementById("orderList");
                orderList.innerHTML = "";
                json.data.forEach((order, i) => {
                    json.pick_orders.forEach(po => {
                        if (po.order === order.id) {
                            if (po.item === 1) {
                                json.data[i].first = po
                            } else if (po.item === 2) {
                                json.data[i].second = po
                            } else if (po.item === 3) {
                                json.data[i].third = po
                            }
                        }
                    });

                    //console.log(json.data)

                    var row = document.createElement("tr");
                    var cell = document.createElement("td");
                    cell.setAttribute("class","align-middle  text-center")
                    var cellText = document.createTextNode(order.id);
                    cell.appendChild(cellText);
                    row.appendChild(cell);
                    var cell = document.createElement("td");
                    cell.setAttribute("class","align-middle  text-center")
                    var worker = json.workers.find(({id}) => id === order.worker)
                    var cellText = document.createTextNode(worker.title);
                    cell.appendChild(cellText);
                    row.appendChild(cell);
                    var cell = document.createElement("td");
                    cell.setAttribute("class","align-middle  text-center")
                    var location = json.locations.find(({id}) => id === order.location)
                    var cellText = document.createTextNode(location.title);
                    cell.appendChild(cellText);
                    row.appendChild(cell);
                    var cell = document.createElement("td");
                    var btn = document.createElement("button")
                    btn.setAttribute("class","btn btn-danger btn-sm")
                    btn.setAttribute("type","button")

                    if (typeof order.first != "undefined") {
                        btn.setAttribute("value",order.first.id)
                        var cellText = document.createTextNode(order.first.quantity);
                        btn.appendChild(cellText);
                        if (order.first.done === true) {
                            btn.setAttribute("class","btn btn-success")
                        } else {
                            btn.setAttribute("class","btn btn-outline-success")
                        }
                    }
                    btn.addEventListener("click", (event) => {
                        confirmOrder(order.first.id);
                    });
                    cell.appendChild(btn);
                    row.appendChild(cell);
                    var cell = document.createElement("td");
                    cell.setAttribute("class","align-middle  text-center")
                    var btn = document.createElement("button")
                    btn.setAttribute("class","btn btn-danger btn-sm")
                    btn.setAttribute("type","button")
                    btn.setAttribute("value",order.second.id)
                    if (typeof order.second != "undefined") {
                        btn.setAttribute("value",order.second.id)
                        var cellText = document.createTextNode(order.second.quantity);
                        btn.appendChild(cellText);
                        if (order.second.done === true) {
                            btn.setAttribute("class","btn btn-success")
                        } else {
                            btn.setAttribute("class","btn btn-outline-success")
                        }
                    }
                    btn.addEventListener("click", (event) => {
                        confirmOrder(order.second.id);
                    });
                    cell.appendChild(btn);
                    row.appendChild(cell);
                    var cell = document.createElement("td");
                    cell.setAttribute("class","align-middle  text-center")
                    var btn = document.createElement("button")
                    btn.setAttribute("class","btn btn-danger btn-sm")
                    btn.setAttribute("type","button")
                    btn.setAttribute("value",order.third.id)
                    if (typeof order.third != "undefined") {
                        btn.setAttribute("value",order.third.id)
                        var cellText = document.createTextNode(order.third.quantity);
                        btn.appendChild(cellText);
                        if (order.third.done === true) {
                            btn.setAttribute("class","btn btn-success")
                        } else {
                            btn.setAttribute("class","btn btn-outline-success")
                        }
                    }
                    btn.addEventListener("click", (event) => {
                        confirmOrder(order.third.id);
                    });
                    cell.appendChild(btn);
                    row.appendChild(cell);
                    var cell = document.createElement("td");
                    cell.setAttribute("class","align-middle  text-center")
                    var cellText = document.createTextNode(new Date(order.request_timestamp * 1000).toLocaleString());
                    cell.appendChild(cellText);
                    row.appendChild(cell);

                    var cell = document.createElement("td");
                    cell.setAttribute("class","align-middle  text-center")
                    var btn = document.createElement("button")
                    btn.setAttribute("class","btn btn-danger mr-1")
                    btn.setAttribute("type","button")
                    btn.setAttribute("value",order.id)
                    var a = document.createElement("a")
                    a.setAttribute("class","fa fa-trash")
                    btn.addEventListener("click", (event) => {
                        deleteOrder(order.id);
                    });
                    btn.appendChild(a)
                    cell.appendChild(btn)
                    var btn = document.createElement("button")
                    btn.setAttribute("class","btn btn-info mr-1")
                    btn.setAttribute("type","button")
                    var a = document.createElement("a")
                    a.setAttribute("class","fa fa-edit")
                    btn.appendChild(a)
                    cell.appendChild(btn)
                    row.appendChild(cell);

                    orderList.appendChild(row);
                });
            })
            .catch(error => console.error("Error updating all orders:", error));
    }
    const fetchCreateOrderForm = () => {
        fetch("/orders")
            .then((response) => response.json())
            .then((json) => {
                const workerSelector = document.getElementById("workerSelect");
                json.workers.forEach((w, i) => {
                    var el = document.createElement("option");
                    el.textContent = w.title
                    el.value = w.id
                    workerSelector.append(el)
                });

                const locationSelector = document.getElementById("locationSelect");
                json.locations.forEach((l, i) => {
                    var el = document.createElement("option");
                    el.textContent = l.title
                    el.value = l.id
                    locationSelector.append(el)
                });
            })
            .catch(error => console.error("Error updating all orders:", error));
    }



    async function sendData() {
        var newOrder = {};
        newOrder.worker = parseInt(document.getElementById("workerSelect").value)
        newOrder.location = parseInt(document.getElementById("locationSelect").value)
        newOrder.pick_orders = [
            {
                "item": 1,
                "quantity": parseInt(document.getElementById("screwSelector").value)
            },
            {
                "item": 2,
                "quantity": parseInt(document.getElementById("boltSelector").value)
            },
            {
                "item": 3,
                "quantity": parseInt(document.getElementById("nutSelector").value)
            }
        ]
        try {
            const response = await fetch("/orders", {
                method: "POST",
                body: JSON.stringify(newOrder),
            });
            console.log(await response.json());
        } catch (e) {
            console.error(e);
        }
    }
    document.getElementById("createOrderButton").addEventListener("click", (event) => {
        sendData();
        fetchCurrentOrder();
        fetchOrders();
    });

    fetchCurrentOrder();
    // The form is only generated once
    fetchCreateOrderForm();
    fetchOrders();

    setInterval(() => {
        fetchCurrentOrder();
        fetchOrders();
    }, 1000);
</script>

<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
        integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
        crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.14.6/dist/umd/popper.min.js"
        integrity="sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut"
        crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>

</body>
</html>